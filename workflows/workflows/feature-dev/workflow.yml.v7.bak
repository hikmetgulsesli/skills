# Per-story PR workflow — each story gets its own branch, PR, review, and merge.
# Ralph loop (https://github.com/snarktank/ralph) — each agent runs in a fresh
# session with clean context. Memory persists via git history and progress files.
id: feature-dev
name: Feature Development Workflow
version: 7
description: |
  Per-story PR pipeline. Each user story gets its own branch and pull request.
  Developer: creates story branch → implements → tests → pushes → creates PR.
  Verifier: reviews PR → checks quality → merges to feature branch.
  After all stories: integration test on merged feature branch + final PR to main.
  v7: Per-story PR workflow replacing batch PR approach.

cron:
  interval_ms: 120000  # 2 minutes

polling:
  model: minimax/MiniMax-M2.5
  timeoutSeconds: 120

agents:
  - id: planner
    name: Planner
    role: analysis
    description: Decomposes tasks into ordered user stories.
    workspace:
      baseDir: agents/planner
      files:
        AGENTS.md: agents/planner/AGENTS.md
        SOUL.md: agents/planner/SOUL.md
        IDENTITY.md: agents/planner/IDENTITY.md

  - id: setup
    name: Setup
    role: coding
    description: Prepares environment, creates feature branch, establishes baseline.
    workspace:
      baseDir: agents/setup
      files:
        AGENTS.md: ../../agents/shared/setup/AGENTS.md
        SOUL.md: ../../agents/shared/setup/SOUL.md
        IDENTITY.md: ../../agents/shared/setup/IDENTITY.md

  - id: developer
    name: Developer
    role: coding
    description: Implements features per story with individual PRs.
    workspace:
      baseDir: agents/developer
      files:
        AGENTS.md: agents/developer/AGENTS.md
        SOUL.md: agents/developer/SOUL.md
        IDENTITY.md: agents/developer/IDENTITY.md

  - id: verifier
    name: Verifier
    role: verification
    description: Reviews per-story PRs, approves and merges to feature branch.
    workspace:
      baseDir: agents/verifier
      skills:
        - agent-browser
      files:
        AGENTS.md: ../../agents/shared/verifier/AGENTS.md
        SOUL.md: ../../agents/shared/verifier/SOUL.md
        IDENTITY.md: ../../agents/shared/verifier/IDENTITY.md

  - id: tester
    name: Tester
    role: testing
    description: Integration testing and final PR after all stories are merged.
    workspace:
      baseDir: agents/tester
      files:
        AGENTS.md: agents/tester/AGENTS.md
        SOUL.md: agents/tester/SOUL.md
        IDENTITY.md: agents/tester/IDENTITY.md

steps:
  - id: plan
    agent: planner
    input: |
      Decompose the following task into ordered user stories for autonomous execution.

      TASK:
      {{task}}

      Instructions:
      1. Explore the codebase to understand the stack, conventions, and patterns
      2. Read references/design-standards.md for available palettes and font pairs
      3. Read references/brainstorming-protocol.md for architectural decision-making
      4. Break the task into small user stories (max 20)
      5. Order by dependency: design tokens first, then schema/DB, backend, frontend, integration
      6. Each story must fit in one developer session (one context window)
      7. Every acceptance criterion must be mechanically verifiable
      8. Always include "Typecheck passes" as the last criterion in every story
      9. Every story MUST include test criteria — "Tests for [feature] pass"
      10. The developer is expected to write tests as part of each story

      DESIGN SYSTEM — Select a cohesive design direction for the project:
      - Read references/design-standards.md for available palettes and font pairs
      - Choose: aesthetic direction (minimal, brutalist, luxury, editorial, industrial, organic, playful, corporate)
      - Choose: color palette matching the project's domain (from the 8 palettes in the reference)
      - Choose: font pair (heading + body) from the 10-pair reference table
      - Choose: icon library (Lucide React or Heroicons)
      - NEVER choose: Inter, Roboto, Arial, system-ui fonts
      - NEVER choose: purple gradient as primary aesthetic
      - NEVER plan for emoji icons
      - Include design tokens (CSS custom properties) in the FIRST user story
      - Output: DESIGN_SYSTEM block with chosen values

      Reply with:
      STATUS: done
      REPO: /path/to/repo
      BRANCH: feature-branch-name
      DESIGN_SYSTEM:
        aesthetic: [direction]
        palette: [name]
        heading_font: [font]
        body_font: [font]
        icon_library: [library]
      STORIES_JSON: [ ... array of story objects ... ]
    expects: "STATUS: done"
    max_retries: 2
    on_fail:
      escalate_to: human

  - id: setup
    agent: setup
    input: |
      Prepare the development environment for this feature.

      TASK:
      {{task}}

      REPO: {{repo}}
      BRANCH: {{branch}}

      Instructions:
      1. If the repo directory does not exist: mkdir -p {{repo}} && cd {{repo}} && git init
         If it exists: cd into the repo
      2. CRITICAL - Ensure GitHub remote exists:
         - Run: git remote -v
         - If NO remote named 'origin' exists, create the GitHub repo:
           PROJECT_NAME=$(basename {{repo}})
           gh repo create hikmetgulsesli/$PROJECT_NAME --public --source . --remote origin --push 2>/dev/null || true
         - If remote exists but repo doesn't exist on GitHub:
           gh repo create hikmetgulsesli/$PROJECT_NAME --public --source . --remote origin --push 2>/dev/null || true
         - Verify: git remote -v (must show origin)
      3. Create the feature branch (git checkout -b {{branch}})
      4. Read package.json, CI config, test config to understand the build/test setup
      5. Run the build to establish a baseline
      6. Run the tests to establish a baseline
      7. Create a references/ symlink in the repo root:
         ln -sfn /home/setrox/.openclaw/antfarm-repo/references references
      8. Push the feature branch to remote:
         git push -u origin {{branch}}
      9. Report what you found

      CRITICAL — Your reply MUST include these EXACT keys on separate lines (not nested under other keys):
      STATUS: done
      BUILD_CMD: <the exact build command, e.g. npm run build>
      TEST_CMD: <the exact test command, e.g. npm test>
      CI_NOTES: <brief CI notes>
      BASELINE: <baseline status>
      WARNING: If you omit BUILD_CMD or TEST_CMD, the next step WILL fail. These are REQUIRED.
    expects: "STATUS: done"
    max_retries: 2
    on_fail:
      escalate_to: human

  - id: implement
    agent: developer
    type: loop
    loop:
      over: stories
      completion: all_done
      fresh_session: true
      verify_each: true
      verify_step: verify
    input: |
      Implement the following user story. You are working on ONE story in a fresh session.
      Each story gets its own branch and pull request.

      TASK (overall):
      {{task}}

      REPO: {{repo}}
      BRANCH: {{branch}}
      BUILD_CMD: {{build_cmd}}
      TEST_CMD: {{test_cmd}}

      CURRENT STORY:
      {{current_story}}

      COMPLETED STORIES:
      {{completed_stories}}

      STORIES REMAINING: {{stories_remaining}}

      VERIFY FEEDBACK (if retrying):
      {{verify_feedback}}

      PROGRESS LOG:
      {{progress}}

      BEFORE writing any code:
      1. Read references/design-standards.md — follow ALL rules
      2. Read references/backend-standards.md — follow ALL rules
      3. Read references/web-guidelines.md — check accessibility + performance
      4. NEVER use: emoji icons, Inter/Roboto/Arial fonts, purple gradients, transition:all
      5. ALWAYS use: SVG icons from chosen library, project font pair, project color palette
      6. ALWAYS use: cursor-pointer on clickable elements, hover states, focus-visible rings
      7. ALWAYS use: parameterized queries, typed errors, proper HTTP status codes

      Instructions:
      1. Read progress-{{run_id}}.txt — especially the Codebase Patterns section
      2. cd into {{repo}}

      === PER-STORY BRANCH + PR WORKFLOW ===

      3. Make sure the feature branch is up to date:
         git checkout {{branch}}
         git pull origin {{branch}}

      4. Create a NEW branch for this story from the feature branch:
         STORY_BRANCH="{{current_story_id}}"
         git checkout -b "$STORY_BRANCH"
         IMPORTANT: Remember the STORY_BRANCH name — you MUST include it in your reply.

      5. Implement this story only, following ALL design and backend standards
      6. Write tests for this story's functionality
      7. Run typecheck / build
      8. Run tests to confirm they pass
      9. Commit all changes:
         git add -A
         git commit -m "feat: {{current_story_id}} - {{current_story_title}}"

      10. Push the story branch:
          git push -u origin "$STORY_BRANCH"

      11. Create a Pull Request to the FEATURE BRANCH (not main):
          gh pr create \
            --base {{branch}} \
            --head "$STORY_BRANCH" \
            --title "feat: {{current_story_id}} - {{current_story_title}}" \
            --body "## Story\n{{current_story_id}}: {{current_story_title}}\n\n## Changes\n<describe changes>\n\n## Tests\n<describe tests written>"

      12. Append to progress-{{run_id}}.txt
      13. Update Codebase Patterns if you found reusable patterns

      === END WORKFLOW ===

      CRITICAL — Your reply MUST include ALL of these EXACT keys on separate lines:
      STATUS: done
      STORY_BRANCH: <the exact branch name you created, e.g. us-001-setup-tokens>
      PR: <the full GitHub PR URL, e.g. https://github.com/hikmetgulsesli/repo/pull/1>
      CHANGES: <what you implemented>
      TESTS: <what tests you wrote>
      WARNING: If you omit STORY_BRANCH or PR, the verify step WILL fail. These are REQUIRED.
      WARNING: You MUST create a story branch and PR — do NOT commit directly to the feature branch.
    expects: "STATUS: done"
    max_retries: 2
    on_fail:
      escalate_to: human

  - id: verify
    agent: verifier
    input: |
      Review and merge the developer's pull request for this story.

      TASK (overall):
      {{task}}

      REPO: {{repo}}
      BRANCH: {{branch}}
      STORY_BRANCH: {{story_branch}}
      PR: {{pr}}
      CHANGES: {{changes}}
      TEST_CMD: {{test_cmd}}

      CURRENT STORY:
      {{current_story}}

      PROGRESS LOG:
      {{progress}}

      === PR REVIEW + MERGE WORKFLOW ===

      STEP 1 — Review the PR:
      1. cd into {{repo}}
      2. Checkout the story branch and pull latest:
         git checkout {{story_branch}} && git pull
      3. View the PR diff:
         gh pr diff {{pr}}
      4. Check that code exists (not just TODOs or placeholders)
      5. Verify each acceptance criterion for the story
      6. Run tests: {{test_cmd}}
      7. Run typecheck/build

      STEP 2 — Quality Checks:

      Code Quality:
      - Tests were written for this story's functionality
      - No obvious incomplete work
      - No empty catch blocks or swallowed errors

      Security:
      - .gitignore exists, .env not committed
      - No hardcoded secrets
      - Parameterized queries only (no SQL concatenation)

      Design Quality (if frontend changes):
      - No emoji icons
      - No Inter/Roboto/Arial fonts
      - Cursor-pointer on clickables
      - Hover/focus states present
      - Responsive breakpoints exist
      - Read references/design-checklist.md and check all CRITICAL items
      - Use agent-browser to visually verify if needed

      STEP 3 — Decision:

      If APPROVED:
      1. Approve the PR on GitHub:
         gh pr review {{pr}} --approve --body "Verified: all acceptance criteria met, tests pass, quality checks pass."
      2. Squash-merge the PR to the feature branch:
         gh pr merge {{pr}} --squash --delete-branch
      3. Reply with STATUS: done

      If REJECTED:
      1. Request changes on the PR:
         gh pr review {{pr}} --request-changes --body "Issues found: <list>"
      2. Reply with STATUS: retry and list issues

      === END WORKFLOW ===

      Reply with:
      STATUS: done
      VERIFIED: What you confirmed
      MERGED: true

      Or if issues found:
      STATUS: retry
      ISSUES:
      - What's missing or incomplete
    expects: "STATUS: done"
    on_fail:
      retry_step: implement
      max_retries: 2
      on_exhausted:
        escalate_to: human

  - id: final-test
    agent: tester
    input: |
      Integration testing on the merged feature branch, then create final PR to main.

      TASK:
      {{task}}

      REPO: {{repo}}
      BRANCH: {{branch}}
      BUILD_CMD: {{build_cmd}}
      TEST_CMD: {{test_cmd}}

      PROGRESS LOG:
      {{progress}}

      All individual story PRs have been merged to the feature branch ({{branch}}).
      Now verify everything works together.

      BEFORE testing, read:
      1. references/web-guidelines.md — accessibility and performance standards
      2. references/debugging-protocol.md — systematic debugging if tests fail

      === INTEGRATION TEST WORKFLOW ===

      STEP 1 — Checkout and verify:
      1. cd into {{repo}}
      2. git checkout {{branch}} && git pull origin {{branch}}
      3. Run the full build: {{build_cmd}}
      4. Run the full test suite: {{test_cmd}}

      STEP 2 — Integration testing:
      1. Look for integration issues between stories
      2. If UI feature, use agent-browser to test end-to-end
      3. Check cross-cutting concerns: error handling, edge cases
      4. Verify the overall feature works as a cohesive whole
      5. If frontend: check accessibility (semantic HTML, keyboard nav, aria)
      6. If frontend: check performance (lazy loading, font preload, image dimensions)

      STEP 3 — Create final PR to main:
      1. If all tests pass, create a PR from feature branch to main:
         gh pr create \
           --base main \
           --head {{branch}} \
           --title "feat: {{task_summary}}" \
           --body "## Summary\n<overall summary of all stories>\n\n## Stories Completed\n<list of stories>\n\n## Test Results\n<test summary>"

      If tests fail, follow debugging protocol. Fix issues, commit, push to feature branch.

      === END WORKFLOW ===

      Reply with:
      STATUS: done
      RESULTS: What you tested and outcomes
      FINAL_PR: URL of the PR to main

      Or if issues found:
      STATUS: retry
      FAILURES:
      - Specific test failures or bugs found
    expects: "STATUS: done"
    on_fail:
      retry_step: implement
      max_retries: 2
      on_exhausted:
        escalate_to: human
