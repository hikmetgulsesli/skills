# Per-story PR workflow — each story gets its own branch, PR, review, and merge.
# Ralph loop (https://github.com/snarktank/ralph) — each agent runs in a fresh
# session with clean context. Memory persists via git history and progress files.
id: feature-dev
name: Feature Development Workflow
version: 7.1
description: |
  Per-story PR pipeline. Each user story gets its own branch and pull request.
  Developer: creates story branch → implements → tests → pushes → creates PR.
  Verifier: reviews PR → checks quality → merges to feature branch.
  After all stories: integration test on merged feature branch + final PR to main.
  v7.1: Hardened output format enforcement to prevent missing variable errors.

cron:
  interval_ms: 120000  # 2 minutes

polling:
  model: minimax/MiniMax-M2.5
  timeoutSeconds: 1800

agents:
  - id: planner
    name: Planner
    role: analysis
    description: Decomposes tasks into ordered user stories.
    workspace:
      baseDir: agents/planner
      files:
        AGENTS.md: agents/planner/AGENTS.md
        SOUL.md: agents/planner/SOUL.md
        IDENTITY.md: agents/planner/IDENTITY.md

  - id: setup
    name: Setup
    role: coding
    description: Prepares environment, creates feature branch, establishes baseline.
    workspace:
      baseDir: agents/setup
      files:
        AGENTS.md: ../../agents/shared/setup/AGENTS.md
        SOUL.md: ../../agents/shared/setup/SOUL.md
        IDENTITY.md: ../../agents/shared/setup/IDENTITY.md

  - id: developer
    name: Developer
    role: coding
    description: Implements features per story with individual PRs.
    workspace:
      baseDir: agents/developer
      files:
        AGENTS.md: agents/developer/AGENTS.md
        SOUL.md: agents/developer/SOUL.md
        IDENTITY.md: agents/developer/IDENTITY.md

  - id: verifier
    name: Verifier
    role: verification
    description: Reviews per-story PRs, approves and merges to feature branch.
    workspace:
      baseDir: agents/verifier
      skills:
        - agent-browser
      files:
        AGENTS.md: ../../agents/shared/verifier/AGENTS.md
        SOUL.md: ../../agents/shared/verifier/SOUL.md
        IDENTITY.md: ../../agents/shared/verifier/IDENTITY.md

  - id: tester
    name: Tester
    role: testing
    description: Integration testing and final PR after all stories are merged.
    workspace:
      baseDir: agents/tester
      files:
        AGENTS.md: agents/tester/AGENTS.md
        SOUL.md: agents/tester/SOUL.md
        IDENTITY.md: agents/tester/IDENTITY.md

steps:
  - id: plan
    agent: planner
    input: |
      Decompose the following task into ordered user stories for autonomous execution.

      TASK:
      {{task}}

      Instructions:
      1. Explore the codebase to understand the stack, conventions, and patterns
      2. Read references/design-standards.md for available palettes and font pairs
      3. Read references/brainstorming-protocol.md for architectural decision-making
      4. Break the task into small, focused user stories (as many as needed)
      5. Order by dependency: design tokens first, then schema/DB, backend, frontend, integration
      6. Each story must fit in one developer session (one context window)
      7. Every acceptance criterion must be mechanically verifiable
      8. Always include "Typecheck passes" as the last criterion in every story
      9. Every story MUST include test criteria — "Tests for [feature] pass"
      10. The developer is expected to write tests as part of each story

      DESIGN SYSTEM — Select a cohesive design direction for the project:
      - Read references/design-standards.md for available palettes and font pairs
      - Choose: aesthetic direction (minimal, brutalist, luxury, editorial, industrial, organic, playful, corporate)
      - Choose: color palette matching the project's domain (from the 8 palettes in the reference)
      - Choose: font pair (heading + body) from the 10-pair reference table
      - Choose: icon library (Lucide React or Heroicons)
      - NEVER choose: Inter, Roboto, Arial, system-ui fonts
      - NEVER choose: purple gradient as primary aesthetic
      - NEVER plan for emoji icons
      - Include design tokens (CSS custom properties) in the FIRST user story

      ============================================================
      MANDATORY OUTPUT FORMAT — PIPELINE WILL BREAK IF YOU SKIP ANY KEY
      ============================================================
      Your ENTIRE reply must follow this EXACT format. Every key is REQUIRED.
      Extract REPO and BRANCH from the TASK above. If REPO is in the task, copy it exactly.
      If BRANCH is not in the task, generate a short kebab-case branch name.

      STATUS: done
      REPO: <exact repo path, e.g. /home/setrox/myproject>
      BRANCH: <branch name, e.g. feature-name>
      DESIGN_SYSTEM:
        aesthetic: <direction>
        palette: <name>
        heading_font: <font>
        body_font: <font>
        icon_library: <library>
      STORIES_JSON:
      [
        {
          "id": "US-001",
          "title": "Short title of first story",
          "description": "What this story implements",
          "acceptanceCriteria": ["Criterion 1 passes", "Criterion 2 passes", "Typecheck passes"]
        },
        {
          "id": "US-002",
          "title": "Short title of second story",
          "description": "What this story implements",
          "acceptanceCriteria": ["Criterion 1 passes", "Tests for feature pass", "Typecheck passes"]
        }
      ]

      FAILURE WARNING: If your reply does not contain "REPO:", "BRANCH:", and "STORIES_JSON:" on their own lines, the ENTIRE pipeline crashes. These are NOT optional. STORIES_JSON must be valid JSON array with objects containing id, title, description, acceptanceCriteria fields.
      ============================================================
    expects: "STATUS: done"
    max_retries: 2
    on_fail:
      escalate_to: human

  - id: setup
    agent: setup
    input: |
      ############################################################
      CRITICAL EXECUTION RULES — VIOLATION BREAKS THE PIPELINE
      ############################################################
      - You MUST do ALL work directly in this session. Do NOT spawn sub-agents.
      - Do NOT delegate to background processes. Do NOT use nohup or &.
      - Do NOT create parallel tasks. Work sequentially in THIS session.
      - Complete ALL steps (code, test, commit, push, PR) before replying.
      - If a task is too complex, simplify your implementation — do NOT delegate.
      ############################################################

      Prepare the development environment for this feature.

      TASK:
      {{task}}

      REPO: {{repo}}
      BRANCH: {{branch}}

      Instructions:
      1. If the repo directory does not exist: mkdir -p {{repo}} && cd {{repo}} && git init
         If it exists: cd into the repo
      2. CRITICAL - Ensure GitHub remote exists:
         - Run: git remote -v
         - If NO remote named 'origin' exists, create the GitHub repo:
           PROJECT_NAME=$(basename {{repo}})
           gh repo create hikmetgulsesli/$PROJECT_NAME --public --source . --remote origin --push 2>/dev/null || true
         - If remote exists but repo doesn't exist on GitHub:
           gh repo create hikmetgulsesli/$PROJECT_NAME --public --source . --remote origin --push 2>/dev/null || true
         - Verify: git remote -v (must show origin)
      3. Create the feature branch (git checkout -b {{branch}})
      4. Read package.json, CI config, test config to understand the build/test setup
      5. Run the build to establish a baseline
      6. Run the tests to establish a baseline
      7. Create a references/ symlink in the repo root:
         ln -sfn /home/setrox/.openclaw/antfarm-repo/references references
      8. Push the feature branch to remote:
         git push -u origin {{branch}}
      9. Report what you found

      ============================================================
      MANDATORY OUTPUT FORMAT — PIPELINE WILL BREAK IF YOU SKIP ANY KEY
      ============================================================
      STATUS: done
      BUILD_CMD: <the exact build command, e.g. pnpm run build>
      TEST_CMD: <the exact test command, e.g. pnpm test>
      CI_NOTES: <brief CI notes>
      BASELINE: <baseline status>

      FAILURE WARNING: If your reply does not contain "BUILD_CMD:" and "TEST_CMD:" on their own lines, the implement step crashes. These are NOT optional.
      ============================================================
    expects: "STATUS: done"
    max_retries: 2
    on_fail:
      escalate_to: human

  - id: implement
    agent: developer
    type: loop
    loop:
      over: stories
      completion: all_done
      fresh_session: true
      verify_each: true
      verify_step: verify
    input: |
      ############################################################
      CRITICAL EXECUTION RULES — VIOLATION BREAKS THE PIPELINE
      ############################################################
      - You MUST do ALL work directly in this session. Do NOT spawn sub-agents.
      - Do NOT delegate to background processes. Do NOT use nohup or &.
      - Do NOT create parallel tasks. Work sequentially in THIS session.
      - Complete ALL steps (code, test, commit, push, PR) before replying.
      - If a task is too complex, simplify your implementation — do NOT delegate.
      ############################################################

      Implement the following user story. You are working on ONE story in a fresh session.
      Each story gets its own branch and pull request.

      TASK (overall):
      {{task}}

      REPO: {{repo}}
      BRANCH: {{branch}}
      BUILD_CMD: {{build_cmd}}
      TEST_CMD: {{test_cmd}}

      CURRENT STORY:
      {{current_story}}

      COMPLETED STORIES:
      {{completed_stories}}

      STORIES REMAINING: {{stories_remaining}}

      VERIFY FEEDBACK (if retrying):
      {{verify_feedback}}

      PROGRESS LOG:
      {{progress}}
      - You MUST do ALL work directly in this session. Do NOT spawn sub-agents.
      - Do NOT delegate to background processes. Do NOT use nohup or &.
      - Do NOT create parallel tasks. Work on ONE story sequentially.
      - Complete ALL steps (code, test, commit, push, PR) in THIS session.
      - If a task is too complex, simplify your implementation — do NOT delegate.
      ############################################################

      BEFORE writing any code:
      1. Read references/design-standards.md — follow ALL rules
      2. Read references/backend-standards.md — follow ALL rules
      3. Read references/web-guidelines.md — check accessibility + performance
      4. NEVER use: emoji icons, Inter/Roboto/Arial fonts, purple gradients, transition:all
      5. ALWAYS use: SVG icons from chosen library, project font pair, project color palette
      6. ALWAYS use: cursor-pointer on clickable elements, hover states, focus-visible rings
      7. ALWAYS use: parameterized queries, typed errors, proper HTTP status codes

      Instructions:
      1. Read progress-{{run_id}}.txt — especially the Codebase Patterns section
      2. cd into {{repo}}

      === PER-STORY BRANCH + PR WORKFLOW ===

      3. Make sure the feature branch is up to date:
         git checkout {{branch}}
         git pull origin {{branch}}

      4. Create a NEW branch for this story from the feature branch:
         STORY_BRANCH="{{current_story_id}}"
         git checkout -b "$STORY_BRANCH"
         IMPORTANT: Remember the STORY_BRANCH name — you MUST include it in your reply.

      5. Implement this story only, following ALL design and backend standards
      6. Write tests for this story's functionality
      7. Run typecheck / build
      8. Run tests to confirm they pass
      9. Commit all changes:
         git add -A
         git commit -m "feat: {{current_story_id}} - {{current_story_title}}"

      10. Push the story branch:
          git push -u origin "$STORY_BRANCH"

      11. Create a Pull Request to the FEATURE BRANCH (not main):
          PR_URL=$(gh pr create \
            --base {{branch}} \
            --head "$STORY_BRANCH" \
            --title "feat: {{current_story_id}} - {{current_story_title}}" \
            --body "## Story
          {{current_story_id}}: {{current_story_title}}

          ## Changes
          <describe changes>

          ## Tests
          <describe tests written>")
          echo "Created PR: $PR_URL"

      12. Append to progress-{{run_id}}.txt
      13. Update Codebase Patterns if you found reusable patterns

      === END WORKFLOW ===

      ============================================================
      MANDATORY OUTPUT FORMAT — PIPELINE WILL BREAK IF YOU SKIP ANY KEY
      ============================================================
      The FIRST 4 lines of your reply MUST be exactly:

      STATUS: done
      STORY_BRANCH: {{current_story_id}}
      PR: <the full GitHub PR URL that gh pr create printed>
      CHANGES: <what you implemented>
      TESTS: <what tests you wrote>

      FAILURE WARNING: If your reply does not contain "STORY_BRANCH:" and "PR:" on their own lines, the verify step crashes and the ENTIRE pipeline stops. These are NOT optional.
      STORY_BRANCH must be the exact branch name (e.g. us-001). PR must be a full URL (e.g. https://github.com/hikmetgulsesli/repo/pull/1).
      ============================================================
    expects: "STATUS: done"
    max_retries: 2
    on_fail:
      escalate_to: human

  - id: verify
    agent: verifier
    input: |
      ############################################################
      CRITICAL EXECUTION RULES — VIOLATION BREAKS THE PIPELINE
      ############################################################
      - You MUST do ALL work directly in this session. Do NOT spawn sub-agents.
      - Do NOT delegate to background processes. Do NOT use nohup or &.
      - Do NOT create parallel tasks. Work sequentially in THIS session.
      - Complete ALL steps (code, test, commit, push, PR) before replying.
      - If a task is too complex, simplify your implementation — do NOT delegate.
      ############################################################

      Review and merge the developer's pull request for this story.

      TASK (overall):
      {{task}}

      REPO: {{repo}}
      BRANCH: {{branch}}
      STORY_BRANCH: {{story_branch}}
      PR: {{pr}}
      CHANGES: {{changes}}
      TEST_CMD: {{test_cmd}}

      CURRENT STORY:
      {{current_story}}

      PROGRESS LOG:
      {{progress}}

      === PR REVIEW + MERGE WORKFLOW ===
      - You MUST do ALL work directly in this session. Do NOT spawn sub-agents.
      - Do NOT delegate to background processes. Do NOT use nohup or &.
      - Do NOT create parallel tasks. Work sequentially.
      - Complete ALL steps in THIS session.
      - If a task is too complex, simplify — do NOT delegate.
      ############################################################

      STEP 1 — Review the PR:
      1. cd into {{repo}}
      2. Checkout the story branch and pull latest:
         git checkout {{story_branch}} && git pull
      3. View the PR diff:
         gh pr diff {{pr}}
      4. Check that code exists (not just TODOs or placeholders)
      5. Verify each acceptance criterion for the story
      6. Run tests: {{test_cmd}}
      7. Run typecheck/build

      STEP 2 — Quality Checks:

      Code Quality:
      - Tests were written for this story's functionality
      - No obvious incomplete work
      - No empty catch blocks or swallowed errors

      Security:
      - .gitignore exists, .env not committed
      - No hardcoded secrets
      - Parameterized queries only (no SQL concatenation)

      Design Quality (if frontend changes):
      - No emoji icons
      - No Inter/Roboto/Arial fonts
      - Cursor-pointer on clickables
      - Hover/focus states present
      - Responsive breakpoints exist
      - Read references/design-checklist.md and check all CRITICAL items
      - Use agent-browser to visually verify if needed

      STEP 3 — Decision:

      If APPROVED:
      1. Approve the PR on GitHub:
         gh pr review {{pr}} --approve --body "Verified: all acceptance criteria met, tests pass, quality checks pass."
      2. Squash-merge the PR to the feature branch:
         gh pr merge {{pr}} --squash --delete-branch
      3. Close any duplicate/stale open PRs targeting the same base branch:
         STALE_PRS=$(gh pr list --base {{branch}} --state open --json number,headRefName -q '.[] | select(.headRefName != "{{story_branch}}") | .number')
         for stale_pr in $STALE_PRS; do
           gh pr close "$stale_pr" --delete-branch 2>/dev/null || true
           echo "Closed stale PR #$stale_pr"
         done
      4. Reply with STATUS: done

      If REJECTED:
      1. Request changes on the PR:
         gh pr review {{pr}} --request-changes --body "Issues found: <list>"
      2. Reply with STATUS: retry and list issues

      === END WORKFLOW ===

      Reply with:
      STATUS: done
      VERIFIED: What you confirmed
      MERGED: true

      Or if issues found:
      STATUS: retry
      ISSUES:
      - What's missing or incomplete
    expects: "STATUS: done"
    on_fail:
      retry_step: implement
      max_retries: 2
      on_exhausted:
        escalate_to: human

  - id: final-test
    agent: tester
    input: |
      ############################################################
      CRITICAL EXECUTION RULES — VIOLATION BREAKS THE PIPELINE
      ############################################################
      - You MUST do ALL work directly in this session. Do NOT spawn sub-agents.
      - Do NOT delegate to background processes. Do NOT use nohup or &.
      - Do NOT create parallel tasks. Work sequentially in THIS session.
      - Complete ALL steps (code, test, commit, push, PR) before replying.
      - If a task is too complex, simplify your implementation — do NOT delegate.
      ############################################################

      Integration testing on the merged feature branch, then create final PR to main.

      TASK:
      {{task}}

      REPO: {{repo}}
      BRANCH: {{branch}}
      BUILD_CMD: {{build_cmd}}
      TEST_CMD: {{test_cmd}}

      PROGRESS LOG:
      {{progress}}

      All individual story PRs have been merged to the feature branch ({{branch}}).
      Now verify everything works together.

      BEFORE testing, read:
      1. references/web-guidelines.md — accessibility and performance standards
      2. references/debugging-protocol.md — systematic debugging if tests fail

      === INTEGRATION TEST WORKFLOW ===

      STEP 1 — Checkout and verify:
      1. cd into {{repo}}
      2. git checkout {{branch}} && git pull origin {{branch}}
      3. Run the full build: {{build_cmd}}
      4. Run the full test suite: {{test_cmd}}

      STEP 2 — Integration testing:
      1. Look for integration issues between stories
      2. If UI feature, use agent-browser to test end-to-end
      3. Check cross-cutting concerns: error handling, edge cases
      4. Verify the overall feature works as a cohesive whole
      5. If frontend: check accessibility (semantic HTML, keyboard nav, aria)
      6. If frontend: check performance (lazy loading, font preload, image dimensions)

      STEP 3 — Create final PR to main AND auto-merge:
      1. If all tests pass, create a PR from feature branch to main:
         FINAL_PR=$(gh pr create \
           --base main \
           --head {{branch}} \
           --title "feat: complete {{branch}} feature" \
           --body "## Summary
      Feature branch {{branch}} with all stories implemented and tested.

      ## Test Results
      <test summary>")
         echo "Created final PR: $FINAL_PR"

      2. Auto-merge the final PR (squash merge, delete feature branch):
         gh pr merge "$FINAL_PR" --squash --delete-branch
         echo "Merged and cleaned up feature branch."

      3. Close any remaining open PRs targeting the feature branch:
         OPEN_PRS=$(gh pr list --base {{branch}} --state open --json number -q '.[].number')
         for pr_num in $OPEN_PRS; do
           gh pr close "$pr_num" --delete-branch 2>/dev/null || true
           echo "Closed orphan PR #$pr_num"
         done

      If tests fail, follow debugging protocol. Fix issues, commit, push to feature branch.

      === END WORKFLOW ===

      Reply with:
      STATUS: done
      RESULTS: What you tested and outcomes
      FINAL_PR: URL of the PR to main

      Or if issues found:
      STATUS: retry
      FAILURES:
      - Specific test failures or bugs found
    expects: "STATUS: done"
    on_fail:
      retry_step: implement
      max_retries: 2
      on_exhausted:
        escalate_to: human
